<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Calculadora posición Bolsa CLM</title>

<!-- Tailwind (CDN) -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.3/dist/tailwind.min.css" rel="stylesheet">

<style>
  body { font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
  .spinner {
    width:72px; height:72px; border-radius:9999px;
    border:8px solid rgba(0,0,0,0.08); border-top-color:#7c3aed;
    animation: spin 1s linear infinite; margin:auto;
  }
  @keyframes spin { to{transform:rotate(360deg)} }
  .small { font-size:0.9rem }
  pre.debug { max-height:220px; overflow:auto; background:#0b1220; color:#cbd5e1; padding:12px; border-radius:6px; }
</style>
</head>
<body class="bg-gradient-to-r from-sky-50 via-violet-50 to-pink-50 min-h-screen flex items-start justify-center py-12">

<div id="root" class="w-full max-w-3xl mx-auto px-4">

  <div id="loaderWrap" class="flex flex-col items-center gap-6">
    <div class="spinner" aria-hidden></div>
    <div class="text-center text-gray-600">Inicializando lector de PDFs…</div>
  </div>

  <main id="app" class="hidden bg-white rounded-2xl shadow-2xl p-8">
    <h1 class="text-2xl font-bold text-violet-700 mb-4">Calculadora posición — Bolsa CLM</h1>

    <p class="small text-gray-600 mb-4">Busca por <strong>apellidos</strong>. Puedes marcar "Mirar adjudicados" para excluir/contar adjudicados.</p>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
      <div class="md:col-span-2">
        <label class="block text-sm font-medium mb-1">Apellidos</label>
        <input id="inputSurname" type="text" placeholder="Ej: LOPEZ CONCEPCION" class="w-full border rounded p-2" />
      </div>

      <div class="space-y-2">
        <label class="block text-sm font-medium mb-1 invisible">Acciones</label>
        <button id="btnSearch" class="w-full bg-violet-600 text-white p-2 rounded font-semibold hover:bg-violet-700">Buscar</button>
        <button id="btnDebugToggle" class="w-full border p-2 rounded text-sm">Ver diagnóstico (debug)</button>
      </div>
    </div>

    <div class="flex gap-4 items-center mb-4 text-sm">
      <label class="inline-flex items-center gap-2"><input id="chkIncludeUnavailable" type="checkbox" /> Contar NO disponibles</label>
      <label class="inline-flex items-center gap-2"><input id="chkIncludeAward" type="checkbox" /> Mirar también adjudicados</label>
    </div>

    <div id="summary" class="mb-4 text-sm text-gray-700"></div>

    <div id="matches" class="mb-4"></div>

    <div id="resultPanel" class="bg-violet-50 p-4 rounded hidden">
      <div id="resultHtml" class="prose"></div>
    </div>

    <hr class="my-4">

    <details id="debug" class="text-sm" style="display:none">
      <summary class="cursor-pointer py-2 font-medium">Información de diagnóstico</summary>
      <div class="mt-2 space-y-3">
        <div>
          <div class="font-semibold">Especialidades detectadas (ordinaria)</div>
          <pre id="dbgOrdinaria" class="debug"></pre>
        </div>
        <div>
          <div class="font-semibold">Especialidades detectadas (reserva)</div>
          <pre id="dbgReserva" class="debug"></pre>
        </div>
        <div>
          <div class="font-semibold">Primeros 1200 caracteres (ordinaria) - texto extraído</div>
          <pre id="dbgText" class="debug"></pre>
        </div>
      </div>
    </details>

    <div class="mt-6 text-xs text-gray-500">
      Nota: si falta alguna especialidad o ves resultados incorrectos, abre el diagnóstico y pegame aquí lo que salga para ajustar la extracción exacta.
    </div>
  </main>
</div>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
(async function app() {
  const URLS = {
    ordinaria: './ordinaria.pdf',
    reserva: './reserva.pdf',
    adjudicados: './adjudicados.pdf'
  };

  const loaderWrap = document.getElementById('loaderWrap');
  const appMain = document.getElementById('app');
  const inputSurname = document.getElementById('inputSurname');
  const btnSearch = document.getElementById('btnSearch');
  const btnDebugToggle = document.getElementById('btnDebugToggle');
  const chkIncludeUnavailable = document.getElementById('chkIncludeUnavailable');
  const chkIncludeAward = document.getElementById('chkIncludeAward');
  const summary = document.getElementById('summary');
  const matchesDiv = document.getElementById('matches');
  const resultPanel = document.getElementById('resultPanel');
  const resultHtml = document.getElementById('resultHtml');
  const debugEl = document.getElementById('debug');
  const dbgOrdinaria = document.getElementById('dbgOrdinaria');
  const dbgReserva = document.getElementById('dbgReserva');
  const dbgText = document.getElementById('dbgText');

  if (!window.pdfjsLib) {
    loaderWrap.innerHTML = '<div class="text-red-600">Error cargando pdf.js</div>';
    return;
  }
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  function normalize(s){
    return (s||'').toUpperCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/\s+/g,' ').trim();
  }

  async function extractTextFromPdf(url){
    const resp = await fetch(url);
    if (!resp.ok) throw new Error('PDF not found: ' + url);
    const buf = await resp.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: buf}).promise;
    let out = '';
    for (let p=1; p<=pdf.numPages; p++){
      const page = await pdf.getPage(p);
      const content = await page.getTextContent();
      out += ' \n' + content.items.map(it => it.str).join(' ');
    }
    return normalize(out);
  }

  function parseBySpecialty(fullText){
    const lines = fullText.split(/\n/).map(l=>l.trim()).filter(Boolean);
    const specialties = {};
    let currentSpec = 'GENERAL';

    for (let i=0;i<lines.length;i++){
      const line = lines[i];
      const isHeader = (
        /^[A-ZÁÉÍÓÚÑÜ \-()]{4,120}$/.test(line) && !/\d/.test(line)
      ) || /ESPECIALIDAD|CUERPO|CONCURSO|BOLSA/.test(line);

      if (isHeader) {
        currentSpec = line.replace(/\s{2,}/g,' ').trim();
        if (!specialties[currentSpec]) specialties[currentSpec]=[];
        continue;
      }

      const m = line.match(/^\s*(\d{1,4})\s+(.+)$/);
      if (m){
        const order = parseInt(m[1],10);
        let rest = m[2].trim();
        let status = 'DISPONIBLE';

        if (/NO\s+DISPONIBLE/.test(rest)) {
          status = 'NO DISPONIBLE';
          rest = rest.replace(/NO\s+DISPONIBLE/, '').trim();
        } else if (/DISPONIBLE/.test(rest)) {
          status = 'DISPONIBLE';
          rest = rest.replace(/DISPONIBLE/, '').trim();
        }

        specialties[currentSpec] = specialties[currentSpec] || [];
        specialties[currentSpec].push({
          order,
          name: rest,
          fullName: rest,
          rawLine: line,
          status
        });
      }
    }
    return specialties;
  }

  function buildFinalLists(specOrdinaria, specReserva, includeUnavailable){
    const ordFiltered = includeUnavailable ? specOrdinaria.slice() : specOrdinaria.filter(r=>r.status==='DISPONIBLE');
    const resFiltered = includeUnavailable ? specReserva.slice() : specReserva.filter(r=>r.status==='DISPONIBLE');
    ordFiltered.sort((a,b)=>a.order-b.order);
    resFiltered.sort((a,b)=>a.order-b.order);
    const final = [];
    ordFiltered.forEach((r)=> final.push({...r, source:'ORDINARIA', finalPosition: final.length+1}));
    resFiltered.forEach((r)=> final.push({...r, source:'RESERVA', finalPosition: final.length+1}));
    return final;
  }

  let textOrd='', textRes='', textAdj='';
  try {
    summary.innerText = 'Descargando y analizando PDFs…';
    textOrd = await extractTextFromPdf(URLS.ordinaria);
    textRes = await extractTextFromPdf(URLS.reserva);
    try { textAdj = await extractTextFromPdf(URLS.adjudicados); } catch(e){ textAdj = ''; }
  } catch(e){
    loaderWrap.innerHTML = '<div class="text-red-600">Error leyendo los PDFs</div>';
    console.error(e);
    return;
  }

  const parsedOrd = parseBySpecialty(textOrd);
  const parsedRes = parseBySpecialty(textRes);
  const parsedAdj = textAdj ? parseBySpecialty(textAdj) : {};

  const specialtiesSet = new Set([...Object.keys(parsedOrd), ...Object.keys(parsedRes)]);
  const specialties = Array.from(specialtiesSet).filter(s=>s && s.length>2);

  dbgOrdinaria.textContent = Object.keys(parsedOrd).join('\n');
  dbgReserva.textContent = Object.keys(parsedRes).join('\n');
  dbgText.textContent = textOrd.slice(0,1200);

  loaderWrap.style.display = 'none';
  appMain.classList.remove('hidden');
  summary.innerHTML = `<strong>Especialidades detectadas:</strong> ${specialties.length}`;

  btnDebugToggle.addEventListener('click', ()=> {
    debugEl.style.display = debugEl.style.display === 'none' ? 'block' : 'none';
    debugEl.open = !debugEl.open;
  });

  btnSearch.addEventListener('click', ()=> {
    resultPanel.classList.add('hidden');
    resultHtml.innerHTML = '';
    matchesDiv.innerHTML = '';

    const raw = inputSurname.value || '';
    const search = normalize(raw);
    if (!search) { summary.innerHTML = '<span class="text-red-600">Introduce apellidos</span>'; return; }

    const hits = [];
    for (const spec of specialties){
      const ordList = parsedOrd[spec] || [];
      const resList = parsedRes[spec] || [];
      const finalList = buildFinalLists(ordList, resList, chkIncludeUnavailable.checked);

      finalList.forEach(row=>{
        const normFull = normalize(row.fullName || row.name);
        if (normFull.includes(search)) {
          hits.push({ spec, row });
        }
      });
    }

    if (hits.length === 0) {
      summary.innerHTML = `<span class="text-red-600">No se encontraron coincidencias para <strong>${raw}</strong></span>`;
      return;
    }

    const grouped = {};
    hits.forEach(h=>{
      grouped[h.spec] = grouped[h.spec] || [];
      grouped[h.spec].push(h.row);
    });

    matchesDiv.innerHTML = '';
    Object.keys(grouped).forEach(spec => {
      const rows = grouped[spec];
      const box = document.createElement('div');
      box.className = 'mb-3 p-3 border rounded bg-white';
      box.innerHTML = `<div class="font-semibold">${spec} — coincidencias: ${rows.length}</div>`;
      rows.forEach(r=>{
        const btn = document.createElement('button');
        btn.className = 'mt-2 block w-full text-left p-2 rounded border hover:bg-violet-50 small';
        btn.innerHTML = `Pos en su lista: <strong>${r.order}</strong> — ${r.fullName} — <em>${r.status}</em>`;
        btn.addEventListener('click', ()=> showFinalPosition(spec, r));
        box.appendChild(btn);
      });
      matchesDiv.appendChild(box);
    });

    summary.innerHTML = `<strong>${hits.length}</strong> coincidencia(s) encontradas.`;
  });

  function showFinalPosition(spec, selectedRow){
    const ordList = parsedOrd[spec] || [];
    const resList = parsedRes[spec] || [];
    const finalList = buildFinalLists(ordList, resList, chkIncludeUnavailable.checked);
    const found = finalList.find(f => f.order === selectedRow.order && normalize(f.fullName) === normalize(selectedRow.fullName));
    if (!found){
      resultHtml.innerHTML = '<div class="text-red-600">No se pudo calcular la posición</div>';
      resultPanel.classList.remove('hidden');
      return;
    }
    const pos = found.finalPosition;
    const source = found.source;
    const ordCount = (ordList.filter(r=> chkIncludeUnavailable.checked ? true : r.status==='DISPONIBLE')).length;
    const resCount = (resList.filter(r=> chkIncludeUnavailable.checked ? true : r.status==='DISPONIBLE')).length;
    let html = `<div class="text-lg font-semibold">Resultado para <span class="text-violet-800">${selectedRow.fullName}</span></div>`;
    html += `<div class="mt-2">Especialidad: <strong>${spec}</strong></div>`;
    html += `<div class="mt-1">Fuente: <strong>${source}</strong></div>`;
    html += `<div class="mt-1">Posición dentro de ${source}: <strong>${selectedRow.order}</strong></div>`;
    html += `<div class="mt-1">Total ordinaria: <strong>${ordCount}</strong></div>`;
    html += `<div class="mt-1">Total reserva: <strong>${resCount}</strong></div>`;
    html += `<div class="mt-2 text-xl">Posición acumulada: <strong class="text-violet-700">${pos}</strong></div>`;
    if (chkIncludeAward.checked && parsedAdj[spec]){
      const normSelected = normalize(selectedRow.fullName);
      const inAdj = parsedAdj[spec].some(a => normalize(a.fullName).includes(normSelected));
      if (inAdj) html += `<div class="mt-2 text-sm text-green-700">Aparece también en adjudicados.</div>`;
    }
    resultHtml.innerHTML = html;
    resultPanel.classList.remove('hidden');
    window.scrollTo({ top: resultPanel.offsetTop - 20, behavior:'smooth' });
  }
})();
</script>

</body>
</html>
